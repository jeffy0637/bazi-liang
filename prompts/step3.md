# Step 3: 刑沖合會與拱夾暗拱

## 任務

計算地支間的刑沖合會關係，以及拱夾暗拱結構。此步驟**必須使用 bazi_engine 的 step3 輸出**。

## 輸入

```
前一步輸出: {step2_output}
bazi_engine.step3: {engine_step3}
```

## 處理流程

1. 讀取 bazi_engine.compute_relations() 的輸出
2. 讀取 bazi_engine.compute_gong_jia_an_gong() 的輸出
3. **執行結構性警告檢查**（見下方）
4. 整理並輸出

## 輸出格式 (JSON)

```json
{
  "step": 3,
  "task": "刑沖合會與拱夾暗拱",
  "relations": [
    {
      "type": "六合|六沖|三合|半三合|三會|刑|害|破|天干合|天干沖|自刑",
      "elements": ["X", "Y"],
      "positions": ["年", "月"],
      "result": "合化結果（如適用）",
      "note": "備註（如適用）"
    }
  ],
  "gong_jia_an_gong": [
    {
      "type": "拱|夾|暗拱",
      "elements": ["X", "Y"],
      "positions": ["年", "日"],
      "target": "被拱/夾的支",
      "result_wuxing": "五行"
    }
  ],
  "structural_warnings": [
    {
      "warning_type": "拱夾與原局沖",
      "description": "X拱Y，但原局有Z沖Y",
      "severity": "high|medium|low"
    }
  ],
  "observations": [
    "年月 子丑 六合化土",
    "年時 子卯 相刑（無禮之刑）",
    "寅戌 暗拱午火（午不在原局）"
  ],
  "applied_rules": [],
  "confidence": 1.0,
  "engine_source": "bazi_engine.step3"
}
```

## 結構性警告檢查（必須執行）

### 1. 拱夾與原局相沖檢查

若命盤中有暗拱或夾：
- 檢查被拱/夾的目標支是否與原局地支相沖
- 若相沖，記錄警告

```
六沖對照：
子-午、丑-未、寅-申、卯-酉、辰-戌、巳-亥
```

**範例**：
- 寅戌暗拱午，原局有子 → 警告「午與子沖，暗拱午力量受損」
- 申辰暗拱子，原局有午 → 警告「子與午沖，暗拱子力量受損」

### 2. 合中帶沖檢查

若同時存在合與沖：
- 記錄「合中帶沖」的結構特徵

**範例**：
- 子丑合，同時子午沖 → 警告「子丑合同時子午沖，合力減弱」

### 3. 刑沖同現檢查

若同一支同時參與刑和沖：
- 記錄「刑沖交加」的結構特徵

## 規則

### 必須遵守

1. **禁止自行判斷刑沖合會** — 必須使用 bazi_engine 的輸出
2. **必須執行結構性警告檢查** — 這是本步驟的核心驗證
3. **confidence 固定為 1.0** — 關係計算為確定性

### observations 撰寫規範

只描述結構性事實，不做吉凶判斷：

- ✅ "年月子丑六合化土"
- ✅ "日時寅巳相刑（無恩之刑）"
- ✅ "寅午戌三合火局"
- ✅ "寅戌暗拱午，但原局子沖午"
- ❌ "六合主和諧"（這是解讀）
- ❌ "相刑主災禍"（這是解讀）
- ❌ "三合火局大利南方"（這是解讀）

### structural_warnings 嚴重度定義

| 等級 | 定義 |
|------|------|
| high | 直接相沖（拱的目標與原局支相沖）|
| medium | 間接影響（合中帶沖）|
| low | 輕微影響（刑害同現）|

## 禁止事項

- ❌ 禁止從案例故事反推規則
- ❌ 禁止在 observations 中加入任何吉凶判斷
- ❌ 禁止引用 rules/ 目錄外的規則
- ❌ 禁止忽略結構性警告檢查
- ❌ 禁止自行編造刑沖合會關係

## 附錄：關係類型參考

### 六合
| 組合 | 化 |
|------|-----|
| 子丑 | 土 |
| 寅亥 | 木 |
| 卯戌 | 火 |
| 辰酉 | 金 |
| 巳申 | 水 |
| 午未 | 火 |

### 六沖
子午、丑未、寅申、卯酉、辰戌、巳亥

### 三合
| 組合 | 化 |
|------|-----|
| 寅午戌 | 火 |
| 申子辰 | 水 |
| 巳酉丑 | 金 |
| 亥卯未 | 木 |

### 三會
| 組合 | 方 |
|------|-----|
| 寅卯辰 | 東方木 |
| 巳午未 | 南方火 |
| 申酉戌 | 西方金 |
| 亥子丑 | 北方水 |
