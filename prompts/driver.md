# Driver: 梁派八字分析總控

## 概述

本 driver 實現梁派「十項主流程」，分為三個階段：

```
Stage 0: 原局特徵表（開局掃描）
Stage 1: 十項主流程（①-⑩）
Stage 2: 矛盾清單與覆蓋規則
```

## 核心原則

### 梁派硬規則（必須遵守）

1. **嚴格順序**：Step ① → ② → ... → ⑩，不可跳步
2. **禁用百分比**：量度只用「最重/重/中/輕」四級
3. **每條結論必須有 Rule ID**：無規則支持的結論標記為「待查」
4. **證據權重**：S級可定主線，A級強支持，B級輔助，C級參考

### 女命協議

女命論斷需額外參考 `female_protocol.md`，特別注意：
- 官殺混雜的不同解讀
- 傷官見官的影響差異
- 六親星神的男女不同

## 三階段執行流程

```
┌─────────────────────────────────────────────────────────────┐
│                       Stage 0                                │
│                    原局特徵表 + 開局掃描                      │
├─────────────────────────────────────────────────────────────┤
│ 輸入：birth_data, gender                                     │
│ 輸出：四柱、藏干、十神、旬空、月令主格                        │
│ 引擎：bazi_engine.to_full_json() + geju_engine               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Stage 1                                │
│                    十項主流程 ①-⑩                            │
├─────────────────────────────────────────────────────────────┤
│ ① 五行是否不全（含落空下修）                                 │
│ ② 陰陽有無偏枯                                               │
│ ③ 刑沖合會形態（含量度分級）                                 │
│ ④ 神煞與日主生剋                                             │
│ ⑤ 六親概括（含旺絕+落空）                                    │
│ ⑥ 年時關聯與牽制                                             │
│ ⑦ 調候用神喜忌（兩層）                                       │
│ ⑧ 格局順逆與用格喜忌                                         │
│ ⑨ 日主強弱扶抑                                               │
│ ⑩ 備註/覆蓋條款                                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Stage 2                                │
│                    矛盾清單 + 覆蓋規則                        │
├─────────────────────────────────────────────────────────────┤
│ 輸出：                                                       │
│ - 各項發現之間的矛盾點                                       │
│ - 覆蓋優先級（哪項蓋過哪項）                                 │
│ - 主線定調（最多3條）                                        │
│ - 待查清單（無法定論的項目）                                 │
└─────────────────────────────────────────────────────────────┘
```

## 十項主流程詳解

### ① 五行是否不全

- 統計五行（含地支藏干）
- 缺失五行標記及六親影響
- **旬空下修**：落空的地支，其藏干五行力量減半

### ② 陰陽有無偏枯

- 統計天干地支陰陽分布
- 判斷偏枯類型：全陽/全陰/陽多/陰多/平衡
- 偏枯對性格和六親的影響

### ③ 刑沖合會形態

- 列出所有刑沖合會關係
- 標註量度：最重/重/中/輕
- 三合三會成局標記為「最重」

### ④ 神煞與日主生剋

- 列出命帶神煞
- 神煞與日主的生剋關係
- 注意：梁派對神煞持謹慎態度，不過度強調

### ⑤ 六親概括

- 十神對應六親
- 六親的旺絕狀態
- 六親是否落空（旬空）

### ⑥ 年時關聯與牽制

- 年柱與時柱的天剋地沖
- 年時的相生相剋
- 對祖上與子女宮的影響

### ⑦ 調候用神喜忌

- **第一層**：日主對月令的寒暖燥濕
- **第二層**：格局對月令的調候需求
- 調候用神的喜忌

### ⑧ 格局順逆與用格喜忌

- 月令主格判定
- 順用/逆用判定
- 破格檢測
- 格局用神與相神

### ⑨ 日主強弱扶抑

- 日主在四柱中的強弱
- 需扶或需抑
- 注意：扶抑是最後一項，不可先入為主

### ⑩ 備註/覆蓋條款

- 特殊情況說明
- 規則覆蓋（哪項蓋過哪項）
- 女命特殊處理

## 輸出格式

### Stage 0 輸出

```json
{
  "stage0": {
    "四柱": { "年柱": {...}, "月柱": {...}, "日柱": {...}, "時柱": {...} },
    "日主": "甲",
    "藏干": { "年支": [...], "月支": [...], "日支": [...], "時支": [...] },
    "十神": { "items": [...], "summary": {...} },
    "旬空": { "xun_shou": "甲子", "kong_zhi": ["戌", "亥"], "kong_positions": [...] },
    "月令主格": { "月支": "巳", "本氣": "丙", "主格": "食神格" }
  }
}
```

### Stage 1 輸出

```json
{
  "stage1": {
    "①五行": {
      "finding": "五行俱全/缺X",
      "detail": {...},
      "xunkong_xiuzheng": "無/X落空，X五行力量減半",
      "applied_rules": ["R0001"],
      "confidence": "A"
    },
    "②陰陽": {
      "finding": "陰多/陽多/平衡",
      "detail": {...},
      "applied_rules": [],
      "confidence": "B"
    },
    // ... ③-⑩
  }
}
```

### Stage 2 輸出

```json
{
  "stage2": {
    "矛盾清單": [
      { "item1": "①五行缺水", "item2": "⑦調候需水", "resolution": "調候優先" }
    ],
    "覆蓋規則": [
      { "higher": "⑦調候", "lower": "⑨扶抑", "reason": "冬夏極端，調候為先" }
    ],
    "主線定調": [
      "食神生財，求財有道",
      "調候用水，喜金水運"
    ],
    "待查清單": [
      { "item": "格局是否破", "reason": "需進一步查證破格條件" }
    ]
  }
}
```

## 引擎調用

### Python 調用示例

```python
from scripts.bazi_engine import BaziEngine
from scripts.geju_engine import GejuEngine
from scripts.yongshen_engine import YongShenEngine

# Stage 0
bazi = BaziEngine.from_ganzhi("己丑", "己巳", "甲子", "辛未")
stage0 = bazi.to_full_json()

# 格局分析
geju = GejuEngine(bazi)
geju_result = geju.to_json()

# 用神分析
yongshen = YongShenEngine(bazi, geju)
yongshen_result = yongshen.to_json()
```

### CLI 調用示例

```bash
# 基礎計算（含十神、旬空、陰陽）
python -m scripts.bazi_engine --year 己丑 --month 己巳 --day 甲子 --hour 辛未 --full

# 格局分析
python -m scripts.geju_engine --year 己丑 --month 己巳 --day 甲子 --hour 辛未

# 用神分析
python -m scripts.yongshen_engine --year 己丑 --month 己巳 --day 甲子 --hour 辛未
```

## 驗證清單

### Stage 0 驗證
- [ ] 四柱與 bazi_engine 一致
- [ ] 十神計算正確
- [ ] 旬空計算正確
- [ ] 月令主格判定正確

### Stage 1 驗證
- [ ] 十項按順序執行
- [ ] 每項都有 finding 和 confidence
- [ ] 量度使用四級制，非百分比
- [ ] applied_rules 只引用 rules/ 內的規則

### Stage 2 驗證
- [ ] 矛盾點都有 resolution
- [ ] 主線不超過3條
- [ ] 待查清單有明確的待查原因

## 倫理聲明

每次分析必須包含：

```
本分析基於梁派八字理論，僅供參考研究，不構成人生決策依據。
命理學為統計推論，個體差異大，實際人生取決於個人選擇與環境機遇。
```
