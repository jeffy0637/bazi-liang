# Stage 1: 十項主流程

## 概述

Stage 1 執行梁派十項主流程，每項必須按順序執行，不可跳步。

## 執行原則

1. **嚴格順序**：① → ② → ... → ⑩
2. **每項獨立輸出**：每項都有 finding、detail、applied_rules、confidence
3. **量度四級制**：最重/重/中/輕，禁用百分比
4. **規則引用**：只引用 rules/ 內的 rule_id

---

## ① 五行是否不全

### 目的
檢查五行是否齊全，標記缺失及其影響。

### 數據來源
```python
five_elements = bazi.compute_five_elements(include_hidden=True)
xunkong = bazi.compute_xunkong()
```

### 判斷標準

| 狀態 | 定義 |
|------|------|
| 五行俱全 | 金木水火土皆有（含藏干） |
| 缺X | 某五行計數為 0 |

### 旬空下修

若某地支落空，其藏干五行力量**減半**：

```python
if zhi in xunkong.kong_zhi:
    for hidden_stem in DIZHI_CANGGAN[zhi]:
        五行力量 *= 0.5
```

### 輸出格式

```json
{
  "①五行": {
    "finding": "五行俱全" | "缺X",
    "detail": {
      "counts": {"金": 1.6, "木": 1.3, "水": 2.5, "火": 2.5, "土": 6.5},
      "missing": [],
      "dominant": "土"
    },
    "xunkong_xiuzheng": "無" | "X支落空，藏干力量減半",
    "六親影響": "缺X，X對應六親緣薄",
    "applied_rules": [],
    "confidence": "A"
  }
}
```

---

## ② 陰陽有無偏枯

### 目的
統計陰陽分布，判斷偏枯類型。

### 數據來源
```python
yinyang = bazi.compute_yinyang_balance()
```

### 判斷標準

| 類型 | 定義 |
|------|------|
| 全陽 | 8 個字全陽 |
| 全陰 | 8 個字全陰 |
| 陽多 | 陽 ≥ 陰 + 4 |
| 陰多 | 陰 ≥ 陽 + 4 |
| 平衡 | 其他情況 |

### 影響

- **全陽**：剛強、衝動、不易妥協
- **全陰**：柔弱、猶豫、善於周旋
- **陽多**：外向、主動
- **陰多**：內斂、被動

### 輸出格式

```json
{
  "②陰陽": {
    "finding": "陰多" | "陽多" | "平衡" | "全陽" | "全陰",
    "detail": {
      "天干": {"陽": 1, "陰": 3},
      "地支": {"陽": 1, "陰": 3},
      "總計": {"陽": 2, "陰": 6}
    },
    "性格影響": "陰多，性格內斂",
    "applied_rules": [],
    "confidence": "B"
  }
}
```

---

## ③ 刑沖合會形態

### 目的
識別所有刑沖合會關係，並標註量度。

### 數據來源
```python
relations = bazi.compute_relations_with_liangdu()
gong_jia = bazi.compute_gong_jia_an_gong()
```

### 量度定義

| 關係 | 量度 |
|------|------|
| 三合/三會成局 | 最重 |
| 六沖/相刑 | 重 |
| 六合/半三合 | 中 |
| 害/破/自刑 | 輕 |

### 輸出格式

```json
{
  "③刑沖合會": {
    "finding": "有X沖、X合、X刑...",
    "relations": [
      {"type": "六沖", "elements": ["丑", "未"], "positions": ["年", "時"], "liangdu": "重"},
      ...
    ],
    "gong_jia": [
      {"type": "暗拱", "elements": ["丑", "巳"], "target": "酉", "result_wuxing": "金"}
    ],
    "結構警示": "暗拱與原局沖則需警惕",
    "applied_rules": [],
    "confidence": "A"
  }
}
```

---

## ④ 神煞與日主生剋

### 目的
識別命帶神煞，及其與日主的關係。

### 梁派態度
梁派對神煞持謹慎態度，**不過度強調**，僅作參考。

### 常見神煞

| 神煞 | 定義（簡化） |
|------|-------------|
| 天乙貴人 | 日干對應貴人支 |
| 文昌貴人 | 日干對應文昌支 |
| 月德貴人 | 月支對應德神 |
| 桃花 | 日/年支對應桃花支 |
| 驛馬 | 日/年支對應驛馬支 |

### 輸出格式

```json
{
  "④神煞": {
    "finding": "命帶天乙貴人、文昌貴人",
    "神煞列表": [
      {"name": "天乙貴人", "position": "年支", "與日主關係": "貴人在財位"}
    ],
    "梁派提醒": "神煞僅供參考，不宜過度解讀",
    "applied_rules": [],
    "confidence": "C"
  }
}
```

---

## ⑤ 六親概括

### 目的
根據十神判斷六親狀態。

### 數據來源
```python
shishen_summary = bazi.get_shishen_summary()
xunkong = bazi.compute_xunkong()
```

### 六親對照

| 十神 | 男命 | 女命 |
|------|------|------|
| 正財 | 妻 | 婆婆 |
| 偏財 | 父 | 父 |
| 正官 | 女兒 | 丈夫 |
| 七殺 | 兒子 | 情人 |
| 正印 | 母 | 母 |
| 食神 | 孫輩 | 女兒 |
| 傷官 | 女兒 | 兒子 |

### 旺絕判定

- **旺**：十神計數 ≥ 3
- **中**：十神計數 1-2
- **弱**：十神計數 0 或藏而不透

### 落空判定

若六親星在落空柱位，標記「落空」。

### 輸出格式

```json
{
  "⑤六親": {
    "finding": "財旺、官旺、印弱...",
    "detail": {
      "財星": {"狀態": "旺", "落空": false, "六親": "妻/父"},
      "官星": {"狀態": "中", "落空": false, "六親": "女兒"},
      ...
    },
    "applied_rules": [],
    "confidence": "B"
  }
}
```

---

## ⑥ 年時關聯與牽制

### 目的
分析年柱與時柱的關係，影響祖上與子女宮。

### 檢查項目

1. **天剋地沖**：年時天干相剋 + 地支相沖
2. **天合地合**：年時天干相合 + 地支相合
3. **相生相剋**：年時五行關係

### 影響

| 關係 | 影響 |
|------|------|
| 年時相沖 | 祖上與子女緣薄，或居住變動 |
| 年時相合 | 祖上與子女關係良好 |
| 年生時 | 祖上蔭子女 |
| 時生年 | 子女孝順祖上 |

### 輸出格式

```json
{
  "⑥年時關聯": {
    "finding": "年時無明顯沖剋",
    "年柱": "己丑",
    "時柱": "辛未",
    "關係": "天干己辛無合沖，地支丑未沖",
    "影響": "年時地支沖，祖居可能有變動",
    "applied_rules": [],
    "confidence": "B"
  }
}
```

---

## ⑦ 調候用神喜忌

### 目的
確定調候用神及喜忌。

### 數據來源
```python
from scripts.yongshen_engine import YongShenEngine
yongshen = YongShenEngine(bazi)
tiaohuo = yongshen.get_tiaohuo_yongshen()
```

### 兩層調候

1. **第一層**：日主對月令
   - 日主五行 + 月令季節 → 調候需求

2. **第二層**：格局對月令
   - 格局五行 + 月令季節 → 格局調候

### 輸出格式

```json
{
  "⑦調候": {
    "finding": "調候用水",
    "第一層": {
      "日主": "甲",
      "月令": "巳（夏）",
      "需求": "夏木焦枯，急需水潤",
      "用神": "水",
      "輔助": null
    },
    "第二層": {
      "格局": "食神格",
      "月令": "巳（夏）",
      "需求": "食神在夏，火旺土焦",
      "用神": "水"
    },
    "喜忌": {
      "喜": ["水", "金"],
      "忌": ["火", "土"]
    },
    "applied_rules": [],
    "confidence": "A"
  }
}
```

---

## ⑧ 格局順逆與用格喜忌

### 目的
確定格局、順逆用、用神。

### 數據來源
```python
from scripts.geju_engine import GejuEngine
geju = GejuEngine(bazi)
geju_result = geju.to_json()
```

**重要**：引擎已完成格局判定（`主格判定`），LLM 直接採信或覆蓋，無需重新判斷。

### 引擎輸出結構

引擎 `geju.to_json()` 輸出包含：

```json
{
  "主格判定": {
    "主格": "食神格",
    "取格方法": "月令藏干透干",
    "推導過程": [
      {
        "步驟": 1,
        "名稱": "三合三會+透干",
        "檢測結果": {...},
        "結論": "不成立",
        "取格": null,
        "兼格": null
      },
      {
        "步驟": 2,
        "名稱": "月令藏干透干",
        "檢測結果": {...},
        "結論": "成立",
        "取格": "食神格",
        "兼格": null
      }
    ],
    "兼格": null,
    "置信度": "A"
  },
  "月令數據": {...},
  "取格證據": {...},
  "專旺格數據": {...},
  "從格數據": {...},
  "破格數據": {...},
  "順逆用數據": {...}
}
```

### 梁派取格四步驟（引擎已實現）

| 步驟 | 方法 | 優先級 |
|------|------|--------|
| 第一步 | 三合三會 + 透干 | 最高（置信度 S） |
| 第二步 | 月令藏干透干（本氣 > 中氣 > 餘氣） | 高 |
| 第二步補充 | 四見成格（某五行 ≥ 4 次） | 高 |
| 第三步 | 月令本氣（無透干時） | 中 |
| 第四步 | 比劫 → 建祿格/羊刃格轉換 | 轉換 |

### LLM 角色

1. **直接採信**：引擎 `主格判定.主格` 為主格
2. **覆蓋條件**：若發現引擎未考慮的特殊情況（如從格成立），在 ⑩備註 中標註覆蓋
3. **順逆判定**：參考 `順逆用數據`

### 順用/逆用

| 類型 | 格局 | 用法 |
|------|------|------|
| 順用 | 官、印、食、財 | 護格、助格 |
| 逆用 | 殺、傷、梟、刃 | 制化、引泄 |

### 破格檢測

參考 `破格數據`：
- 沖破：格神被沖
- 合去：格神被合化異類
- 傷格：不利元素傷害格神

### 輸出格式

```json
{
  "⑧格局": {
    "finding": "食神格，順用",
    "主格判定": {
      "主格": "食神格",
      "取格方法": "月令藏干透干",
      "兼格": null,
      "置信度": "A"
    },
    "順逆": "順用",
    "破格": false,
    "用格喜忌": {
      "用神": "財星（土）",
      "喜": ["土", "火"],
      "忌": ["水", "木"]
    },
    "applied_rules": [],
    "confidence": "A"
  }
}
```

---

## ⑨ 日主強弱扶抑

### 目的
判斷日主強弱，確定扶抑方向。

### 注意
**扶抑是最後一項**，不可先入為主。

### 強弱判定因素

1. **得令**：日主在月令是否當旺
2. **得地**：日主在地支是否有根
3. **得勢**：天干是否有比劫印星相助
4. **得氣**：整體五行是否助日主

### 強弱分類

| 類型 | 定義 |
|------|------|
| 強 | 得令 + 得地/得勢 |
| 中和 | 有扶有抑，大致平衡 |
| 弱 | 失令 + 無根無助 |
| 極弱 | 弱極無根，可能從格 |

### 輸出格式

```json
{
  "⑨扶抑": {
    "finding": "日主中和偏弱",
    "detail": {
      "得令": false,
      "得地": true,
      "得勢": false,
      "得氣": false
    },
    "強弱": "中和偏弱",
    "扶抑方向": "宜扶不宜抑",
    "applied_rules": [],
    "confidence": "B"
  }
}
```

---

## ⑩ 備註/覆蓋條款

### 目的
記錄特殊情況和規則覆蓋。

### 內容

1. **特殊情況**：不適用一般規則的情況
2. **規則覆蓋**：哪項規則蓋過哪項
3. **女命處理**：女命特殊論斷（參考 female_protocol.md）

### 輸出格式

```json
{
  "⑩備註": {
    "特殊情況": [
      "月支藏七殺餘氣，力量存疑"
    ],
    "規則覆蓋": [
      {"higher": "調候", "lower": "扶抑", "reason": "夏月極熱，調候優先"}
    ],
    "女命處理": null,
    "applied_rules": [],
    "confidence": "B"
  }
}
```

---

## 完整輸出範例

```json
{
  "stage1": {
    "①五行": {...},
    "②陰陽": {...},
    "③刑沖合會": {...},
    "④神煞": {...},
    "⑤六親": {...},
    "⑥年時關聯": {...},
    "⑦調候": {...},
    "⑧格局": {...},
    "⑨扶抑": {...},
    "⑩備註": {...}
  }
}
```

---

## 數據解讀指南（供 LLM 判斷用）

**硬計算 vs 軟解讀分工**：
- **硬計算**（引擎完成）：格局判定、刑沖合會、五行統計
- **軟解讀**（LLM 負責）：專旺格/從格判斷、破格嚴重程度、用神權衡

### ⑧ 格局判斷流程

**重要**：引擎 `determine_main_ge()` 已完成梁派取格四步驟，直接使用 `主格判定` 結果。

#### 直接採信（預設行為）

```
從 geju.to_json() 獲取：
- 主格 = 主格判定.主格
- 取格方法 = 主格判定.取格方法
- 置信度 = 主格判定.置信度
- 兼格 = 主格判定.兼格
```

#### 覆蓋條件（需標註於 ⑩備註）

僅當以下情況成立時，LLM 可覆蓋引擎結果：

```
1. 專旺格成立（引擎未處理完整專旺格邏輯）
   - 從 專旺格數據 中判斷
   - 條件：yueling_match + (三合/三會/多數同五行) + 無剋制

2. 從格成立（引擎未處理從格邏輯）
   - 從 從格數據 中判斷
   - 條件：無本氣根 + 低比劫印權重 + 某類十神極旺

覆蓋時必須標註：
{
  "規則覆蓋": [
    {"higher": "從格", "lower": "引擎主格", "reason": "日主極弱無根，從財格成立"}
  ]
}
```

#### 破格檢測

從 `破格數據` 中判斷：

```
破格類型對照：

1. 沖破
   - yuezhi_chong 不為空
   - 若 格局柱後破 == True，破格加重

2. 合去
   - yuezhi_he 不為空 且 五行變質 == True

3. 官殺混雜（正官格專用）
   - 月令主格 == "正官格" 且 guansha_hunza.both_present == True

4. 傷官見官（正官格專用）
   - 月令主格 == "正官格" 且 zhengguange_shangguan_data.has_shangguan_tougan == True

5. 比劫奪財（財格專用）
   - 月令主格 in ["正財格", "偏財格"]
   - caige_bijie_data.has_bijie_tougan == True
   - caige_bijie_data.bijie_weight >= 2.0

6. 財星壞印（印格專用）
   - 月令主格 in ["正印格", "偏印格"]
   - yinge_cai_data.has_cai_tougan == True
   - yinge_cai_data.cai_weight >= 2.0

7. 梟神奪食（食神格專用）
   - 月令主格 == "食神格"
   - shishengs_pianyin_data.has_pianyin_tougan == True

8. 傷官見官（傷官格專用）
   - 月令主格 == "傷官格"
   - shangguange_guan_data.has_guan_tougan == True

9. 殺重身輕（七殺格專用）
   - 月令主格 == "七殺格"
   - qisha_zhihua_data.qisha_weight >= 2.0
   - qisha_zhihua_data.shishen_weight < 1.0（無食神制）
   - qisha_zhihua_data.yinxing_weight < 1.0（無印星化）
   - qisha_zhihua_data.bijie_weight < 1.5（身弱）
```

#### 順逆用判定

從 `順逆用數據` 中判斷：

```
規則：
1. 若 has_sanhe_sanhui_chengjv == True → 逆用
2. 若 is_shunong_ge_candidate == True → 順用
3. 若 is_niyong_ge_candidate == True → 逆用
4. 其他情況 → 待定
```

---

### ⑦ 調候判斷流程

從 `調候數據` 中判斷：

#### Step 1: 獲取調候建議

```
查看 tiaohuo_reference：
- primary: 主調候五行
- auxiliary: 輔調候五行
- reason: 調候理由
```

#### Step 2: 檢查調候五行是否存在

```
查看 existing_tiaohuo：
- 存在: True/False
- 權重: 數值

若主調候五行存在且權重 >= 1.0，調候較佳
若主調候五行不存在或權重 < 0.5，調候不足
```

#### Step 3: 定位調候五行位置

```
查看 tiaohuo_positions：
- 字: 調候五行的字
- 位置: 年/月/日/時
- 層級: 天干/地支/地支藏干
- 十神: 該字的十神

天干調候 > 地支本氣 > 地支藏干（力量遞減）
```

---

### ⑨ 扶抑判斷流程

從 `日主強弱數據` 中判斷：

#### Step 1: 得令判定

```
查看 de_ling_data：
- same_wuxing == True → 得令（月令與日主同五行）
- is_sheng == True → 得生（月令生日主）
- 其他 → 失令
```

#### Step 2: 得地判定

```
查看 de_di_list：
- 有本氣根 → 得地強
- 有中氣根 → 得地中
- 僅餘氣根 → 得地弱
- de_di_count == 0 → 無根
```

#### Step 3: 得勢判定

```
查看 de_shi_list：
- de_shi_count >= 2 → 得勢
- de_shi_count == 1 → 勢中
- de_shi_count == 0 → 無勢
```

#### Step 4: 得氣判定

```
查看 de_qi_data：
- total_support > total_drain → 得氣
- total_support < total_drain → 失氣
- 大致相等 → 氣平
```

#### 綜合判定

```
強：得令 + (得地 or 得勢)
中和：有扶有抑，不偏
弱：失令 + 無根 or 無勢
極弱：失令 + 無根 + 無勢 → 可能從格
```

---

### 通關判斷流程

從 `通關數據` 中判斷：

```
查看 duizhi_data，找到對峙情況：

條件（需要通關）：
- 剋方權重 >= 3.0
- 被剋方權重 >= 3.0

若條件滿足，取該對峙的 通關五行 作為通關用神
```
