# Stage 1: 十項主流程

## 概述

Stage 1 執行梁派十項主流程，每項必須按順序執行，不可跳步。

## 執行原則

1. **嚴格順序**：① → ② → ... → ⑩
2. **每項獨立輸出**：每項都有 finding、detail、applied_rules、confidence
3. **量度四級制**：最重/重/中/輕，禁用百分比
4. **規則引用**：只引用 rules/ 內的 rule_id

---

## ① 五行是否不全

### 目的
檢查五行是否齊全，標記缺失及其影響。

### 數據來源
```python
five_elements = bazi.compute_five_elements(include_hidden=True)
xunkong = bazi.compute_xunkong()
```

### 判斷標準

| 狀態 | 定義 |
|------|------|
| 五行俱全 | 金木水火土皆有（含藏干） |
| 缺X | 某五行計數為 0 |

### 旬空下修

若某地支落空，其藏干五行力量**減半**：

```python
if zhi in xunkong.kong_zhi:
    for hidden_stem in DIZHI_CANGGAN[zhi]:
        五行力量 *= 0.5
```

### 輸出格式

```json
{
  "①五行": {
    "finding": "五行俱全" | "缺X",
    "detail": {
      "counts": {"金": 1.6, "木": 1.3, "水": 2.5, "火": 2.5, "土": 6.5},
      "missing": [],
      "dominant": "土"
    },
    "xunkong_xiuzheng": "無" | "X支落空，藏干力量減半",
    "六親影響": "缺X，X對應六親緣薄",
    "applied_rules": [],
    "confidence": "A"
  }
}
```

---

## ② 陰陽有無偏枯

### 目的
統計陰陽分布，判斷偏枯類型。

### 數據來源
```python
yinyang = bazi.compute_yinyang_balance()
```

### 判斷標準

| 類型 | 定義 |
|------|------|
| 全陽 | 8 個字全陽 |
| 全陰 | 8 個字全陰 |
| 陽多 | 陽 ≥ 陰 + 4 |
| 陰多 | 陰 ≥ 陽 + 4 |
| 平衡 | 其他情況 |

### 影響

- **全陽**：剛強、衝動、不易妥協
- **全陰**：柔弱、猶豫、善於周旋
- **陽多**：外向、主動
- **陰多**：內斂、被動

### 輸出格式

```json
{
  "②陰陽": {
    "finding": "陰多" | "陽多" | "平衡" | "全陽" | "全陰",
    "detail": {
      "天干": {"陽": 1, "陰": 3},
      "地支": {"陽": 1, "陰": 3},
      "總計": {"陽": 2, "陰": 6}
    },
    "性格影響": "陰多，性格內斂",
    "applied_rules": [],
    "confidence": "B"
  }
}
```

---

## ③ 刑沖合會形態

### 目的
識別所有刑沖合會關係，並標註量度。

### 數據來源
```python
relations = bazi.compute_relations_with_liangdu()
gong_jia = bazi.compute_gong_jia_an_gong()
```

### 量度定義

| 關係 | 量度 |
|------|------|
| 三合/三會成局 | 最重 |
| 六沖/相刑 | 重 |
| 六合/半三合 | 中 |
| 害/破/自刑 | 輕 |

### 輸出格式

```json
{
  "③刑沖合會": {
    "finding": "有X沖、X合、X刑...",
    "relations": [
      {"type": "六沖", "elements": ["丑", "未"], "positions": ["年", "時"], "liangdu": "重"},
      ...
    ],
    "gong_jia": [
      {"type": "暗拱", "elements": ["丑", "巳"], "target": "酉", "result_wuxing": "金"}
    ],
    "結構警示": "暗拱與原局沖則需警惕",
    "applied_rules": [],
    "confidence": "A"
  }
}
```

---

## ④ 神煞與日主生剋

### 目的
識別命帶神煞，及其與日主的關係。

### 梁派態度
梁派對神煞持謹慎態度，**不過度強調**，僅作參考。

### 常見神煞

| 神煞 | 定義（簡化） |
|------|-------------|
| 天乙貴人 | 日干對應貴人支 |
| 文昌貴人 | 日干對應文昌支 |
| 月德貴人 | 月支對應德神 |
| 桃花 | 日/年支對應桃花支 |
| 驛馬 | 日/年支對應驛馬支 |

### 輸出格式

```json
{
  "④神煞": {
    "finding": "命帶天乙貴人、文昌貴人",
    "神煞列表": [
      {"name": "天乙貴人", "position": "年支", "與日主關係": "貴人在財位"}
    ],
    "梁派提醒": "神煞僅供參考，不宜過度解讀",
    "applied_rules": [],
    "confidence": "C"
  }
}
```

---

## ⑤ 六親概括

### 目的
根據十神判斷六親狀態。

### 數據來源
```python
shishen_summary = bazi.get_shishen_summary()
xunkong = bazi.compute_xunkong()
```

### 六親對照

| 十神 | 男命 | 女命 |
|------|------|------|
| 正財 | 妻 | 婆婆 |
| 偏財 | 父 | 父 |
| 正官 | 女兒 | 丈夫 |
| 七殺 | 兒子 | 情人 |
| 正印 | 母 | 母 |
| 食神 | 孫輩 | 女兒 |
| 傷官 | 女兒 | 兒子 |

### 旺絕判定

- **旺**：十神計數 ≥ 3
- **中**：十神計數 1-2
- **弱**：十神計數 0 或藏而不透

### 落空判定

若六親星在落空柱位，標記「落空」。

### 輸出格式

```json
{
  "⑤六親": {
    "finding": "財旺、官旺、印弱...",
    "detail": {
      "財星": {"狀態": "旺", "落空": false, "六親": "妻/父"},
      "官星": {"狀態": "中", "落空": false, "六親": "女兒"},
      ...
    },
    "applied_rules": [],
    "confidence": "B"
  }
}
```

---

## ⑥ 年時關聯與牽制

### 目的
分析年柱與時柱的關係，影響祖上與子女宮。

### 檢查項目

1. **天剋地沖**：年時天干相剋 + 地支相沖
2. **天合地合**：年時天干相合 + 地支相合
3. **相生相剋**：年時五行關係

### 影響

| 關係 | 影響 |
|------|------|
| 年時相沖 | 祖上與子女緣薄，或居住變動 |
| 年時相合 | 祖上與子女關係良好 |
| 年生時 | 祖上蔭子女 |
| 時生年 | 子女孝順祖上 |

### 輸出格式

```json
{
  "⑥年時關聯": {
    "finding": "年時無明顯沖剋",
    "年柱": "己丑",
    "時柱": "辛未",
    "關係": "天干己辛無合沖，地支丑未沖",
    "影響": "年時地支沖，祖居可能有變動",
    "applied_rules": [],
    "confidence": "B"
  }
}
```

---

## ⑦ 調候用神喜忌

### 目的
確定調候用神及喜忌。

### 數據來源
```python
from scripts.yongshen_engine import YongShenEngine
yongshen = YongShenEngine(bazi)
tiaohuo = yongshen.get_tiaohuo_yongshen()
```

### 兩層調候

1. **第一層**：日主對月令
   - 日主五行 + 月令季節 → 調候需求

2. **第二層**：格局對月令
   - 格局五行 + 月令季節 → 格局調候

### 輸出格式

```json
{
  "⑦調候": {
    "finding": "調候用水",
    "第一層": {
      "日主": "甲",
      "月令": "巳（夏）",
      "需求": "夏木焦枯，急需水潤",
      "用神": "水",
      "輔助": null
    },
    "第二層": {
      "格局": "食神格",
      "月令": "巳（夏）",
      "需求": "食神在夏，火旺土焦",
      "用神": "水"
    },
    "喜忌": {
      "喜": ["水", "金"],
      "忌": ["火", "土"]
    },
    "applied_rules": [],
    "confidence": "A"
  }
}
```

---

## ⑧ 格局順逆與用格喜忌

### 目的
確定格局、順逆用、用神。

### 數據來源
```python
from scripts.geju_engine import GejuEngine
geju = GejuEngine(bazi)
geju_result = geju.to_json()
```

### 順用/逆用

| 類型 | 格局 | 用法 |
|------|------|------|
| 順用 | 官、印、食、財 | 護格、助格 |
| 逆用 | 殺、傷、梟、刃 | 制化、引泄 |

### 破格檢測

- 沖破：格神被沖
- 合去：格神被合化異類
- 傷格：不利元素傷害格神

### 輸出格式

```json
{
  "⑧格局": {
    "finding": "食神格，順用",
    "月令主格": {
      "月支": "巳",
      "本氣": "丙",
      "主格": "食神格"
    },
    "順逆": "順用",
    "破格": false,
    "用格喜忌": {
      "用神": "財星（土）",
      "喜": ["土", "火"],
      "忌": ["水", "木"]
    },
    "applied_rules": [],
    "confidence": "A"
  }
}
```

---

## ⑨ 日主強弱扶抑

### 目的
判斷日主強弱，確定扶抑方向。

### 注意
**扶抑是最後一項**，不可先入為主。

### 強弱判定因素

1. **得令**：日主在月令是否當旺
2. **得地**：日主在地支是否有根
3. **得勢**：天干是否有比劫印星相助
4. **得氣**：整體五行是否助日主

### 強弱分類

| 類型 | 定義 |
|------|------|
| 強 | 得令 + 得地/得勢 |
| 中和 | 有扶有抑，大致平衡 |
| 弱 | 失令 + 無根無助 |
| 極弱 | 弱極無根，可能從格 |

### 輸出格式

```json
{
  "⑨扶抑": {
    "finding": "日主中和偏弱",
    "detail": {
      "得令": false,
      "得地": true,
      "得勢": false,
      "得氣": false
    },
    "強弱": "中和偏弱",
    "扶抑方向": "宜扶不宜抑",
    "applied_rules": [],
    "confidence": "B"
  }
}
```

---

## ⑩ 備註/覆蓋條款

### 目的
記錄特殊情況和規則覆蓋。

### 內容

1. **特殊情況**：不適用一般規則的情況
2. **規則覆蓋**：哪項規則蓋過哪項
3. **女命處理**：女命特殊論斷（參考 female_protocol.md）

### 輸出格式

```json
{
  "⑩備註": {
    "特殊情況": [
      "月支藏七殺餘氣，力量存疑"
    ],
    "規則覆蓋": [
      {"higher": "調候", "lower": "扶抑", "reason": "夏月極熱，調候優先"}
    ],
    "女命處理": null,
    "applied_rules": [],
    "confidence": "B"
  }
}
```

---

## 完整輸出範例

```json
{
  "stage1": {
    "①五行": {...},
    "②陰陽": {...},
    "③刑沖合會": {...},
    "④神煞": {...},
    "⑤六親": {...},
    "⑥年時關聯": {...},
    "⑦調候": {...},
    "⑧格局": {...},
    "⑨扶抑": {...},
    "⑩備註": {...}
  }
}
```
