# System Architecture

本文檔說明八字命理系統的架構設計，包含硬計算層與軟解讀層的分工、資料流、以及關鍵設計決策。

---

## 架構概覽

```
┌─────────────────────────────────────────────────────────────────┐
│                         用戶輸入                                  │
│              (出生年月日時、性別、問題方向)                          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      硬計算層 (程式碼保證正確)                       │
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  bazi_engine.py │  │  geju_engine.py │  │ yongshen_engine │  │
│  │  排盤/十神/旬空  │  │  格局判定四步驟  │  │   用神數據       │  │
│  │  刑沖合會/拱夾   │  │  主格/兼格/破格  │  │   調候/通關      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ JSON 輸出 (固定格式)
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    軟解讀層 (LLM + Prompts)                       │
│                      語意理解與解讀                               │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐     │
│  │   專旺/從格  │   破格程度   │   用神權衡   │  流年大運    │     │
│  │   特殊判斷   │   嚴重評估   │  調候vs格局  │   時間波動   │     │
│  └─────────────┴─────────────┴─────────────┴─────────────┘     │
│                        ↑                                        │
│                 參考: references/                                │
│                 規則: rules/active/                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        輸出結果                                   │
│              (命盤分析、運勢解讀、建議)                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 層次劃分

### 硬計算層

**特性**：程式碼實現，結果確定性 100%，不依賴 LLM

| 引擎 | 功能 | 輸出欄位 |
|------|------|----------|
| `bazi_engine.py` | 排盤校驗、藏干、十神、旬空、刑沖合會 | `stage0`, `五行`, `陰陽`, `刑沖合會` |
| `geju_engine.py` | **梁派取格四步驟**、月令數據、破格數據 | `主格判定`, `月令數據`, `破格數據` |
| `yongshen_engine.py` | 調候數據、通關數據、日主強弱 | `調候數據`, `日主強弱數據` |

**梁派取格四步驟（geju_engine 核心）**：
1. 三合三會 + 透干 → 最強（置信度 S）
2. 月令藏干透干（本氣 > 中氣 > 餘氣）
3. 月令本氣（無透干時）
4. 比劫 → 建祿格/羊刃格轉換

**設計原則**：
- LLM 不得修改硬計算結果（除非覆蓋條件成立）
- 所有結構性數據由程式碼產生
- 輸出格式固定，便於評估驗證

### 軟解讀層

**特性**：LLM 負責，基於硬計算結果進行語意解讀與權衡

| 功能 | 說明 | 參考 |
|------|------|------|
| 專旺格/從格判斷 | 引擎提供數據，LLM 做最終判定 | `專旺格數據`, `從格數據` |
| 破格嚴重程度 | 引擎檢測破格，LLM 評估影響 | `破格數據` |
| 用神權衡 | 調候 vs 格局 vs 扶抑的優先級 | `yongshen_engine` |
| 六親解讀 | 十神與六親對照 | `shishen.md` |
| 流年大運 | 時間維度波動 | `dayun-liunian.md` |

**設計原則**：
- 必須引用 references/ 文檔，不憑記憶
- 結論需標註規則 ID 與信心度
- 遵守倫理準則 (ETHICS.md)
- 覆蓋引擎結果需在 ⑩備註 中標註

---

## 資料流

```
輸入
  │
  ├─→ bazi_calc.py ─→ 干支計算 ─→ 四柱干支
  │
  └─→ bazi_engine.py
        │
        ├─→ compute_hidden_stems()   → 藏干
        ├─→ compute_shishen()        → 十神
        ├─→ compute_xunkong()        → 旬空
        ├─→ compute_five_elements()  → 五行統計
        ├─→ compute_relations_with_liangdu() → 刑沖合會（含量度）
        └─→ compute_gong_jia_an_gong() → 拱/夾/暗拱
              │
              └─→ JSON 輸出 (stage0)
                    │
                    ▼
              geju_engine.py
                    │
                    ├─→ determine_main_ge()  → 主格判定（四步驟）
                    ├─→ get_poge_data()      → 破格數據
                    └─→ get_shunni_data()    → 順逆用數據
                          │
                          └─→ JSON 輸出 (主格判定 + 輔助數據)
                                │
                                ▼
                          yongshen_engine.py
                                │
                                ├─→ get_tiaohuo_yongshen() → 調候用神
                                ├─→ get_geju_yongshen()    → 格局用神
                                └─→ compute_xiji()         → 喜忌
                                      │
                                      └─→ JSON 輸出 (用神 + 喜忌)
                                            │
                                            ▼
                                      LLM + Prompts
                                            │
                                            ├─→ 讀取 references/
                                            ├─→ 查詢 rules/active/
                                            ├─→ 採信/覆蓋引擎結果
                                            └─→ 產生解讀文本
                                                  │
                                                  ▼
                                            最終輸出 (Markdown)
```

---

## 關鍵設計決策

### 1. LLM 角色限制

**決策**：LLM 只負責 Step 4-7 的解讀，不能修改 Step 0-3 的硬計算結果。

**理由**：
- 避免 LLM 編造不存在的干支關係
- 確保基礎數據可被程式驗證
- 評估時可區分「計算錯誤」vs「解讀錯誤」

### 2. 規則引用規範

**決策**：所有結論必須引用規則 ID，不能憑「案例記憶」推論。

**理由**：
- 可追溯：用戶可查詢規則來源
- 可驗證：規則可被測試案例檢驗
- 可迭代：錯誤規則可標記為 `contested` 或 `deprecated`

### 3. 資料集隔離

**決策**：train/dev/test_locked 三分，test_locked 禁止用於調優。

**理由**：
- 避免過擬合特定案例
- 保留獨立測試集評估泛化能力
- 符合機器學習最佳實踐

---

## 組件依賴

```
                    ┌─────────────┐
                    │  用戶請求   │
                    └──────┬──────┘
                           │
              ┌────────────┴────────────┐
              ▼                         ▼
      ┌───────────────┐         ┌───────────────┐
      │  bazi_calc.py │         │   SKILL.md    │
      │  (日曆計算)    │         │  (技能定義)   │
      └───────┬───────┘         └───────────────┘
              │
              ▼
      ┌───────────────┐
      │bazi_engine.py │
      │  (硬計算)      │
      └───────┬───────┘
              │
      ┌───────┴───────┐
      ▼               ▼
┌───────────┐   ┌───────────┐
│references/│   │  rules/   │
│ (知識庫)  │   │ (規則庫)  │
└─────┬─────┘   └─────┬─────┘
      └───────┬───────┘
              ▼
      ┌───────────────┐
      │    prompts/   │
      │  (LLM 提示)   │
      └───────┬───────┘
              │
              ▼
      ┌───────────────┐
      │   eval/       │
      │  (評估驗證)    │
      └───────────────┘
```

---

## 擴展點

### 新增規則
1. 在 `rules/hypothesis/` 建立 JSON 檔案
2. 用 `dev.txt` 案例驗證
3. 通過後移至 `rules/active/` 並轉為 YAML

### 新增案例
1. 在 `cases/curated/` 建立 JSONL 檔案
2. 在 `cases/splits/` 的適當檔案加入 ID
3. 執行 `eval/run_eval.py` 驗證

### 新增命理知識
1. 在 `references/` 建立 Markdown 檔案
2. 更新 `SKILL.md` 的參考文檔表
3. 更新相關 prompts

---

## 變更紀錄

| 日期 | 版本 | 說明 |
|------|------|------|
| 2026-01-28 | v1.1 | 格局判定移入硬計算層：`geju_engine.determine_main_ge()` 實現梁派取格四步驟 |
| 2026-01-26 | v1.0 | 初始版本 |
