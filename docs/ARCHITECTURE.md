# System Architecture

本文檔說明八字命理系統的架構設計，包含硬計算層與軟解讀層的分工、資料流、以及關鍵設計決策。

---

## 架構概覽

```
┌─────────────────────────────────────────────────────────────────┐
│                         用戶輸入                                  │
│              (出生年月日時、性別、問題方向)                          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   硬計算層 (bazi_engine.py)                       │
│                      程式碼保證正確性                              │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐     │
│  │   Step 0    │   Step 1    │   Step 2    │   Step 3    │     │
│  │  排盤校驗   │  五行統計   │  刑沖合會   │  拱/夾/暗拱  │     │
│  └─────────────┴─────────────┴─────────────┴─────────────┘     │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ JSON 輸出 (固定格式)
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    軟解讀層 (LLM + Prompts)                       │
│                      語意理解與解讀                               │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐     │
│  │   Step 4    │   Step 5    │   Step 6    │   Step 7    │     │
│  │  十神定位   │  格局職業   │   調候     │  流年大運    │     │
│  └─────────────┴─────────────┴─────────────┴─────────────┘     │
│                        ↑                                        │
│                 參考: references/                                │
│                 規則: rules/active/                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        輸出結果                                   │
│              (命盤分析、運勢解讀、建議)                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 層次劃分

### 硬計算層 (Step 0-3)

**特性**：程式碼實現，結果確定性 100%，不依賴 LLM

| 步驟 | 功能 | 輸出欄位 | 實現檔案 |
|------|------|----------|----------|
| Step 0 | 排盤校驗 | `step1.四柱`, `step1.藏干` | `bazi_engine.py` |
| Step 1 | 五行統計 | `step2.counts`, `step2.missing` | `bazi_engine.py` |
| Step 2 | 刑沖合會 | `step3.relations` | `bazi_engine.py` |
| Step 3 | 拱/夾/暗拱 | `step3.gong_jia_an_gong` | `bazi_engine.py` |

**設計原則**：
- LLM 不得修改硬計算結果
- 所有結構性數據由程式碼產生
- 輸出格式固定，便於評估驗證

### 軟解讀層 (Step 4-7)

**特性**：LLM 負責，基於硬計算結果進行語意解讀

| 步驟 | 功能 | 參考文檔 | Prompt |
|------|------|----------|--------|
| Step 4 | 十神定位 | `shishen.md` | 性格/行為傾向描述 |
| Step 5 | 格局職業 | `geju-fenxi.md` | 能力結構、職業方向 |
| Step 6 | 調候 | `wuxing-shengke.md` | 寒暖燥濕調節 |
| Step 7 | 流年大運 | `dayun-liunian.md` | 時間維度波動 |

**設計原則**：
- 必須引用 references/ 文檔，不憑記憶
- 結論需標註規則 ID 與信心度
- 遵守倫理準則 (ETHICS.md)

---

## 資料流

```
輸入
  │
  ├─→ bazi_calc.py ─→ 干支計算 ─→ 四柱干支
  │
  └─→ bazi_engine.py
        │
        ├─→ compute_hidden_stems()   → 藏干
        ├─→ compute_five_elements()  → 五行統計
        ├─→ compute_relations()      → 刑沖合會
        └─→ compute_gong_jia_an_gong() → 拱/夾/暗拱
              │
              └─→ JSON 輸出 (step1, step2, step3)
                    │
                    ▼
              LLM + Prompts
                    │
                    ├─→ 讀取 references/
                    ├─→ 查詢 rules/active/
                    └─→ 產生解讀文本
                          │
                          ▼
                    最終輸出 (Markdown)
```

---

## 關鍵設計決策

### 1. LLM 角色限制

**決策**：LLM 只負責 Step 4-7 的解讀，不能修改 Step 0-3 的硬計算結果。

**理由**：
- 避免 LLM 編造不存在的干支關係
- 確保基礎數據可被程式驗證
- 評估時可區分「計算錯誤」vs「解讀錯誤」

### 2. 規則引用規範

**決策**：所有結論必須引用規則 ID，不能憑「案例記憶」推論。

**理由**：
- 可追溯：用戶可查詢規則來源
- 可驗證：規則可被測試案例檢驗
- 可迭代：錯誤規則可標記為 `contested` 或 `deprecated`

### 3. 資料集隔離

**決策**：train/dev/test_locked 三分，test_locked 禁止用於調優。

**理由**：
- 避免過擬合特定案例
- 保留獨立測試集評估泛化能力
- 符合機器學習最佳實踐

---

## 組件依賴

```
                    ┌─────────────┐
                    │  用戶請求   │
                    └──────┬──────┘
                           │
              ┌────────────┴────────────┐
              ▼                         ▼
      ┌───────────────┐         ┌───────────────┐
      │  bazi_calc.py │         │   SKILL.md    │
      │  (日曆計算)    │         │  (技能定義)   │
      └───────┬───────┘         └───────────────┘
              │
              ▼
      ┌───────────────┐
      │bazi_engine.py │
      │  (硬計算)      │
      └───────┬───────┘
              │
      ┌───────┴───────┐
      ▼               ▼
┌───────────┐   ┌───────────┐
│references/│   │  rules/   │
│ (知識庫)  │   │ (規則庫)  │
└─────┬─────┘   └─────┬─────┘
      └───────┬───────┘
              ▼
      ┌───────────────┐
      │    prompts/   │
      │  (LLM 提示)   │
      └───────┬───────┘
              │
              ▼
      ┌───────────────┐
      │   eval/       │
      │  (評估驗證)    │
      └───────────────┘
```

---

## 擴展點

### 新增規則
1. 在 `rules/hypothesis/` 建立 JSON 檔案
2. 用 `dev.txt` 案例驗證
3. 通過後移至 `rules/active/` 並轉為 YAML

### 新增案例
1. 在 `cases/curated/` 建立 JSONL 檔案
2. 在 `cases/splits/` 的適當檔案加入 ID
3. 執行 `eval/run_eval.py` 驗證

### 新增命理知識
1. 在 `references/` 建立 Markdown 檔案
2. 更新 `SKILL.md` 的參考文檔表
3. 更新相關 prompts

---

## 變更紀錄

| 日期 | 版本 | 說明 |
|------|------|------|
| 2026-01-26 | v1.0 | 初始版本 |
